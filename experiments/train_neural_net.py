# -*- coding: utf-8 -*-
"""train_neural_net.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1JMC0cx45NZ43eVWWXB80s747MOYBlvcp
"""

from google.colab import files
uploaded = files.upload()

import pandas as pd

df = pd.read_csv("synthetic_medical_data.csv")  # datamÄ±z
df.head()

#Veri Temizleme PlanÄ±
from sklearn.model_selection import train_test_split
import pandas as pd

# 1ï¸âƒ£ SayÄ±sal sÃ¼tunlarÄ± median ile doldur
num_cols = df.select_dtypes(exclude='object').columns
df[num_cols] = df[num_cols].fillna(df[num_cols].median())

# 2ï¸âƒ£ Kategorik sÃ¼tunlarÄ± "Missing" ile doldur
cat_cols = df.select_dtypes(include='object').columns
df[cat_cols] = df[cat_cols].fillna("Missing")

# 3ï¸âƒ£ One-hot encoding (kategorik deÄŸiÅŸkenleri sayÄ±ya Ã§evir)
df_encoded = pd.get_dummies(df, drop_first=True)

# 4ï¸âƒ£ BaÄŸÄ±msÄ±z deÄŸiÅŸkenler (X) ve hedef (y)
X = df_encoded.drop("Dead", axis=1)
y = df_encoded["Dead"]

# 5ï¸âƒ£ Veriyi ayÄ±r
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)

print("âœ… Train:", X_train.shape, " Test:", X_test.shape)
print("Ã–rnek sÄ±nÄ±f oranÄ±:", y.value_counts(normalize=True).round(3))

# 5 - Neural Network + K-Fold

!pip install tensorflow pandas scikit-learn --quiet

import pandas as pd
import numpy as np
import tensorflow as tf
from tensorflow.keras import layers, Sequential
from sklearn.model_selection import StratifiedKFold
from sklearn.metrics import (
    accuracy_score, precision_score, recall_score, f1_score,
    roc_auc_score, average_precision_score, matthews_corrcoef
)

# ===================================================
# ðŸ”¹ 1. Veri YÃ¼kleme ve X, y'yi gsu_project'e uygun oluÅŸturma
# ===================================================

# Veri yÃ¼kleme
df = pd.read_csv("synthetic_medical_data.csv")  # ðŸ“„ dosyan senin CSV'n olmalÄ±

# 1ï¸âƒ£ SayÄ±sal sÃ¼tunlarÄ± median ile doldur
num_cols = df.select_dtypes(exclude='object').columns
df[num_cols] = df[num_cols].fillna(df[num_cols].median())

# 2ï¸âƒ£ Kategorik sÃ¼tunlarÄ± "Missing" ile doldur
cat_cols = df.select_dtypes(include='object').columns
df[cat_cols] = df[cat_cols].fillna("Missing")

# 3ï¸âƒ£ One-hot encoding (kategorik deÄŸiÅŸkenleri sayÄ±ya Ã§evir)
df_encoded = pd.get_dummies(df, drop_first=True)

# 4ï¸âƒ£ BaÄŸÄ±msÄ±z deÄŸiÅŸkenler (X) ve hedef (y)
X = df_encoded.drop("Dead", axis=1)
y = df_encoded["Dead"]

print("âœ… Veri hazÄ±rlandÄ±.")
print("X boyutu:", X.shape, " | y boyutu:", y.shape)
print("ðŸ”¹ SÄ±nÄ±f oranÄ±:\n", y.value_counts(normalize=True).round(3))

# ===================================================
# ðŸ”¹ 2. Neural Network + 5-Fold Cross Validation
# ===================================================

metrics = {"accuracy": [], "precision": [], "recall": [], "f1": [],
            "roc_auc": [], "pr_auc": [], "mcc": []}

skf = StratifiedKFold(n_splits=5, shuffle=True, random_state=42)

fold = 1
for train_idx, val_idx in skf.split(X, y):
    print(f"\n========== ðŸ¤– Fold {fold} ==========")
    fold += 1

    X_tr, X_val = X.iloc[train_idx], X.iloc[val_idx]
    y_tr, y_val = y.iloc[train_idx], y.iloc[val_idx]

    # Yapay sinir aÄŸÄ± modeli
    model = Sequential([
        layers.Input(shape=(X_tr.shape[1],)),
        layers.Dense(64, activation='relu'),
        layers.Dense(32, activation='relu'),
        layers.Dense(1, activation='sigmoid')
    ])

    model.compile(optimizer='adam', loss='binary_crossentropy',
                  metrics=[tf.keras.metrics.AUC(name='auc')])

    # 20% validation split ile eÄŸitim
    model.fit(X_tr, y_tr, epochs=40, batch_size=32, validation_split=0.2, verbose=0)

    # Tahminler
    y_proba = model.predict(X_val).ravel()
    y_pred = (y_proba >= 0.5).astype(int)

    # Metrikleri kaydet
    metrics["accuracy"].append(accuracy_score(y_val, y_pred))
    metrics["precision"].append(precision_score(y_val, y_pred, zero_division=0))
    metrics["recall"].append(recall_score(y_val, y_pred, zero_division=0))
    metrics["f1"].append(f1_score(y_val, y_pred, zero_division=0))
    metrics["roc_auc"].append(roc_auc_score(y_val, y_proba))
    metrics["pr_auc"].append(average_precision_score(y_val, y_proba))
    metrics["mcc"].append(matthews_corrcoef(y_val, y_pred))

# ===================================================
# ðŸ”¹ 3. Ortalama SonuÃ§lar
# ===================================================

print("\n========== ðŸ“Š Ortalama SonuÃ§lar (5-Fold) ==========")
for m in metrics:
    print(f"{m.upper():<10}: {np.mean(metrics[m]):.3f} Â± {np.std(metrics[m]):.3f}")

