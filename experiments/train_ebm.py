# -*- coding: utf-8 -*-
"""train_ebm.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1fqKfzK5_k0kwB0nmW8DYbAEkj6_6YEQR
"""

from google.colab import files
uploaded = files.upload()

import pandas as pd

df = pd.read_csv("synthetic_medical_data.csv")  # datamÄ±z
df.head()

#Veri Temizleme PlanÄ±
from sklearn.model_selection import train_test_split
import pandas as pd

# 1ï¸âƒ£ SayÄ±sal sÃ¼tunlarÄ± median ile doldur
num_cols = df.select_dtypes(exclude='object').columns
df[num_cols] = df[num_cols].fillna(df[num_cols].median())

# 2ï¸âƒ£ Kategorik sÃ¼tunlarÄ± "Missing" ile doldur
cat_cols = df.select_dtypes(include='object').columns
df[cat_cols] = df[cat_cols].fillna("Missing")

# 3ï¸âƒ£ One-hot encoding (kategorik deÄŸiÅŸkenleri sayÄ±ya Ã§evir)
df_encoded = pd.get_dummies(df, drop_first=True)

# 4ï¸âƒ£ BaÄŸÄ±msÄ±z deÄŸiÅŸkenler (X) ve hedef (y)
X = df_encoded.drop("Dead", axis=1)
y = df_encoded["Dead"]

# 5ï¸âƒ£ Veriyi ayÄ±r
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)

print("âœ… Train:", X_train.shape, " Test:", X_test.shape)
print("Ã–rnek sÄ±nÄ±f oranÄ±:", y.value_counts(normalize=True).round(3))

features = ['LunchType', 'TestPrep', 'ParentEduc', 'Gender', 'EthnicGroup', 'PracticeSport']
target = 'AvgPass'   # veya 'AvgGrade'

# ðŸ“˜ EBM + K-FOLD

!pip install interpret

import pandas as pd
import numpy as np
from interpret.glassbox import ExplainableBoostingClassifier
from sklearn.model_selection import StratifiedKFold
from sklearn.metrics import (
    accuracy_score, precision_score, recall_score, f1_score,
    roc_auc_score, average_precision_score, matthews_corrcoef
)

# ===============================
# ðŸ”¹ 1. Veri YÃ¼kleme ve Temizleme
# ===============================
df = pd.read_csv("synthetic_medical_data.csv")

# SayÄ±sal sÃ¼tunlarÄ± median ile doldur
num_cols = df.select_dtypes(exclude='object').columns
df[num_cols] = df[num_cols].fillna(df[num_cols].median())

# Kategorik sÃ¼tunlarÄ± "Missing" ile doldur
cat_cols = df.select_dtypes(include='object').columns
df[cat_cols] = df[cat_cols].fillna("Missing")

# One-hot encoding
df_encoded = pd.get_dummies(df, drop_first=True)

# BaÄŸÄ±msÄ±z deÄŸiÅŸkenler (X) ve hedef deÄŸiÅŸken (y)
X = df_encoded.drop("Dead", axis=1)
y = df_encoded["Dead"]

print("âœ… Veri hazÄ±r. X ÅŸekli:", X.shape, "  y ÅŸekli:", y.shape)
print("ðŸ”¹ SÄ±nÄ±f oranÄ±:\n", y.value_counts(normalize=True).round(3))

# ===============================
# ðŸ”¹ 2. EBM + Stratified K-Fold
# ===============================
metrics = {
    "accuracy": [], "precision": [], "recall": [], "f1": [],
    "roc_auc": [], "pr_auc": [], "mcc": []
}

skf = StratifiedKFold(n_splits=5, shuffle=True, random_state=42)

fold = 1
for train_idx, val_idx in skf.split(X, y):
    print(f"\n========== ðŸ“˜ Fold {fold} ==========")
    fold += 1

    X_tr, X_val = X.iloc[train_idx], X.iloc[val_idx]
    y_tr, y_val = y.iloc[train_idx], y.iloc[val_idx]

    model = ExplainableBoostingClassifier(interactions=10, random_state=42)
    model.fit(X_tr, y_tr)

    y_proba = model.predict_proba(X_val)[:, 1]
    y_pred = (y_proba >= 0.5).astype(int)

    # Her foldâ€™un metriklerini topla
    metrics["accuracy"].append(accuracy_score(y_val, y_pred))
    metrics["precision"].append(precision_score(y_val, y_pred, zero_division=0))
    metrics["recall"].append(recall_score(y_val, y_pred, zero_division=0))
    metrics["f1"].append(f1_score(y_val, y_pred, zero_division=0))
    metrics["roc_auc"].append(roc_auc_score(y_val, y_proba))
    metrics["pr_auc"].append(average_precision_score(y_val, y_proba))
    metrics["mcc"].append(matthews_corrcoef(y_val, y_pred))

# ===============================
# ðŸ”¹ 3. Ortalama SonuÃ§lar
# ===============================
print("\n========== ðŸ“Š Ortalama SonuÃ§lar (5-Fold) ==========")
for m in metrics:
    print(f"{m.upper():<10}: {np.mean(metrics[m]):.3f} Â± {np.std(metrics[m]):.3f}")

